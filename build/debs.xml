<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by PHP Project Wizard (PPW) 1.0.4 on Mon Oct 3 15:21:39 CDT 2011 -->

<project name="deb" default="build" basedir=".">
    <property name="deb.phpsetup" value="${basedir}/deb/hugnetlib"/>
    <property name="deb.webapisetup" value="${basedir}/deb/hugnetlib-webapi"/>
    <property name="deb.phpsrc" value="${basedir}/src/php"/>
    <property name="deb.webapisrc" value="${basedir}/src/webapi/html"/>
    <property name="deb.phpstaging" value="${basedir}/build/debphp"/>
    <property name="deb.webapistaging" value="${basedir}/build/debwebapi"/>
    <property name="deb.release" value="" />
    <property name="deb.versionfile" value="${basedir}/src/php/VERSION.TXT" />

    <exec executable="grep" failonerror="true"
        outputproperty="deb.version" errorproperty="deb.versionerror">
        <arg line='-o -e "[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}[~alpha0-9]\{0,\}" ${deb.versionfile}'
            />
    </exec>
    <property name="deb.builddir" value="${basedir}/rel" />
    <property name="deb.phpoutputfile" value="${deb.builddir}/HUGnetLib_${deb.version}${deb.release}_all.deb" />
    <property name="deb.webapioutputfile" value="${deb.builddir}/HUGnetLib-webapi_${deb.version}${deb.release}_all.deb" />
    <property name="deb.postloc" value="hugnet.int.hugllc.com:/home/reprepro/incoming/" />

    <target name="clean" description="Clean up and create artifact directories">
        <delete dir="${deb.phpstaging}" failonerror="false"/>
        <delete dir="${deb.webapistaging}" failonerror="false"/>
        <delete failonerror="false">
            <fileset dir="${deb.builddir}" includes="*.deb"/>
        </delete>
    </target>

    <target name="phpsetup" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetLib 'v${deb.version}'</echo>

        <mkdir dir="${deb.phpstaging}"/>
        <copy todir="${deb.phpstaging}">
            <fileset dir="${deb.phpsetup}" excludes="**/*~"/>
        </copy>
        <mkdir dir="${deb.phpstaging}/usr/share/php/HUGnetLib"/>
        <copy todir="${deb.phpstaging}/usr/share/php/HUGnetLib">
            <fileset dir="${deb.phpsrc}" excludes="**/*~"/>
        </copy>
        <delete dir="${deb.phpstaging}/usr/share/php/HUGnetLib/webapi"/>
        <chmod file="${deb.phpstaging}/DEBIAN/postinst" perm="0755"/>
        <chmod file="${deb.phpstaging}/DEBIAN/prerm" perm="0755"/>
        <chmod file="${deb.phpstaging}/usr/**" perm="0755" type="dir"/>
        <chmod file="${deb.phpstaging}/usr/**" perm="0644" type="file"/>
        <replaceregexp file="${deb.phpstaging}/DEBIAN/control"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="phpdeb" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="fakeroot" failonerror="true">
            <arg line="dpkg-deb --build ${deb.phpstaging}
                       ${deb.phpoutputfile}"/>
        </exec>
    </target>
    <target name="webapisetup" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetLib-webapi 'v${deb.version}'</echo>

        <mkdir dir="${deb.webapistaging}"/>
        <copy todir="${deb.webapistaging}">
            <fileset dir="${deb.webapisetup}" excludes="**/*~"/>
        </copy>
        <mkdir dir="${deb.webapistaging}/var/www/HUGnetLib"/>
        <copy todir="${deb.webapistaging}/var/www/HUGnetLib">
            <fileset dir="${deb.webapisrc}" excludes="**/*~"/>
        </copy>
        <mkdir dir="${deb.webapistaging}/usr/share/php/HUGnetLib/webapi"/>
        <copy todir="${deb.webapistaging}/usr/share/php/HUGnetLib/webapi">
            <fileset dir="${deb.phpsrc}/webapi" excludes="**/*~"/>
        </copy>
        <chmod file="${deb.webapistaging}/DEBIAN/postinst" perm="0755"/>
        <chmod file="${deb.webapistaging}/DEBIAN/prerm" perm="0755"/>
        <replaceregexp file="${deb.webapistaging}/DEBIAN/control" byline="yes"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="webapideb" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="fakeroot" failonerror="true">
            <arg line="dpkg-deb --build ${deb.webapistaging}
                       ${deb.webapioutputfile}"/>
        </exec>
    </target>
    <target name="sign" description="sign the deb">
        <exec executable="dpkg-sig" failonerror="true" dir="${deb.builddir}">
            <arg line="-s builder
                       ${deb.outputfile}"/>
        </exec>
    </target>
    <target name="post" description="post the deb" depends="build">
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.phpoutputfile}
                        ${deb.postloc}main/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.webapioutputfile}
                        ${deb.postloc}main/"/>
        </exec>
    </target>
    <target name="testpost" description="post the deb" depends="build">
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.phpoutputfile}
                        ${deb.postloc}testing/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.webapioutputfile}
                        ${deb.postloc}testing/"/>
        </exec>
    </target>
    <target name="postclean" description="build the deb">
        <delete dir="${deb.phpstaging}"/>
        <delete dir="${deb.webapistaging}"/>
    </target>
    <target name="build" depends="clean,phpsetup,webapisetup,phpdeb,webapideb"/>

</project>
